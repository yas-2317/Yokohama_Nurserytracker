<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>横浜市 保育園 受入可能数・入所待ち人数（年齢別）</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    .modebar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .modebar .badge{ margin-left:auto; }
    th.hide-col, td.hide-col { display:none !important; }

    /* ====== ヘッダー分離型テーブル（確実に表示される） ====== */
    .table-shell{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden; /* 角丸維持 */
    }

    /* ヘッダー枠（横スクロールだけ同期。スクロールバーは隠す） */
    .tablehead-wrap{
      overflow: auto;
      scrollbar-width: none;          /* Firefox */
      -ms-overflow-style: none;       /* IE/Edge legacy */
      background: var(--thead-bg);
    }
    .tablehead-wrap::-webkit-scrollbar{ display:none; } /* Webkit */

    /* 本体枠（縦横スクロール） */
    .tablebody-wrap{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: 70vh;
      background: var(--surface);
    }

    /* 2つの table の基本揃え */
    #tblHead, #tblBody{
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%;
      background: var(--surface);
      color: var(--text);
    }
    #tblHead{ background: transparent; } /* ヘッダー背景は th 側に */

    #tblHead th, #tblBody td{
      padding: 10px 12px;
      border-bottom: 1px solid #eef2f7;
      vertical-align: top;
      white-space: nowrap;
      font-size: 13px;
    }

    /* ヘッダー見た目は styles.css と同等に（確実に） */
    #tblHead th{
      background: var(--thead-bg);
      color: var(--thead-text);
      text-align: left;
      font-weight: 700;
      font-size: 12px;
      line-height: 1.2;
      border-bottom: 1px solid rgba(255,255,255,.15);
    }

    /* 交互行 */
    #tblBody tbody tr:nth-child(even){ background: var(--row-alt); }

    /* 左端固定（園名列）— ヘッダーも本体も */
    .col-name{
      position: sticky;
      left: 0;
      background: var(--surface);
      z-index: 5;
      box-shadow: 1px 0 0 rgba(0,0,0,.10);
    }
    #tblHead th.col-name{
      background: var(--thead-bg);
      color: var(--thead-text);
      z-index: 10;
      box-shadow: 1px 0 0 rgba(255,255,255,.15);
    }

    /* 園名セルの省略（行高を増やさない） */
    #tblBody td.col-name{
      max-width: 360px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 住所列：PCは1行省略（要望） */
    @media (min-width: 769px){
      #tblBody td.col-addr .cell-ellipsis{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        max-width: 520px;
        vertical-align: top;
      }
    }

    /* スマホ：園名列を細くして “園名以外” を見やすく */
    @media (max-width: 768px){
      .tablebody-wrap{ max-height: 75vh; }
      #tblHead, #tblBody{ min-width: 720px; }
      #tblBody td.col-name{ max-width: 110px; }
      .modebar .badge{ width:100%; margin-left:0; }
      .scrollhint{ display:block; margin-top:8px; }
    }

    .scrollhint{
      display:none;
      font-size: 12px;
      opacity: .8;
      padding: 8px 2px 0 2px;
    }
  </style>
</head>

<body>
<header>
  <div class="container">
    <h1>横浜市：保育園ごとの「受入可能数」「入所待ち人数」（年齢別）</h1>
    <div class="sub">データ時点：<span id="monthLabel">-</span> / 施設数：<span id="countLabel">-</span></div>

    <div class="controls">
      <select id="monthSelect"></select>
      <input id="q" placeholder="園名/駅で検索（例：日吉 / ひよし / しんよこはま）" />

      <select id="wardSelect">
        <option value="">全区</option>
      </select>

      <select id="sort">
        <option value="wait0_desc">0歳 入所待ち 多い順</option>
        <option value="wait1_desc">1歳 入所待ち 多い順</option>
        <option value="wait2_desc">2歳 入所待ち 多い順</option>
        <option value="wait35_desc">3〜5歳 入所待ち 多い順</option>
        <option value="wait_desc">合計入所待ち 多い順</option>
        <option value="accept_desc">合計受入可能 多い順</option>
        <option value="station_walk_asc">駅×徒歩（昇順）</option>
        <option value="name_asc">園名（あいうえお）</option>
      </select>

      <button id="toggleCols" type="button">年齢別列：非表示</button>
      <span class="badge">※「入所待ち人数」は園ごとの申込件数（重複計上あり）</span>
    </div>

    <div class="modebar">
      <label class="inline">
        <span class="small">表示モード</span>
        <select id="viewMode">
          <option value="auto">自動（スマホ:コンパクト / PC:詳細）</option>
          <option value="compact">コンパクト（スマホ向け）</option>
          <option value="full">詳細（全列）</option>
        </select>
      </label>
      <span class="badge">スマホはコンパクト推奨（列が少なくなります）</span>
    </div>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="kpi" id="kpi"></div>
    <div class="small"></div>
  </div>

  <div class="card">
    <div class="table-shell">
      <!-- ヘッダー（別テーブル） -->
      <div class="tablehead-wrap" id="headWrap">
        <table id="tblHead">
          <colgroup id="colHead"></colgroup>
          <thead>
            <tr>
              <th data-col="name" class="col-name">園名</th>
              <th data-col="station">最寄り駅</th>
              <th data-col="walk">徒歩</th>

              <th data-col="accept">受入（合計）</th>
              <th data-col="wait">待ち（合計）</th>
              <th data-col="dwait">前月比 待ち</th>
              <th data-col="dacc">前月比 受入</th>

              <th data-col="a0a" class="agecol">0 受入</th>
              <th data-col="a0w" class="agecol">0 待ち</th>
              <th data-col="a1a" class="agecol">1 受入</th>
              <th data-col="a1w" class="agecol">1 待ち</th>
              <th data-col="a2a" class="agecol">2 受入</th>
              <th data-col="a2w" class="agecol">2 待ち</th>
              <th data-col="a35a" class="agecol">3-5 受入</th>
              <th data-col="a35w" class="agecol">3-5 待ち</th>

              <th data-col="addr">住所</th>
              <th data-col="map">地図</th>
            </tr>
          </thead>
        </table>
      </div>

      <!-- 本体（スクロール） -->
      <div class="tablebody-wrap" id="bodyWrap">
        <table id="tblBody">
          <colgroup id="colBody"></colgroup>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="scrollhint">※ スマホは横にスクロールできます（園名列は固定）</div>
  </div>

  <div class="footer">
    出典：横浜市「保育所等の入所状況（毎月1日時点）」の公開データを加工（本サイトは非公式）。
  </div>
</main>

<script src="common.js"></script>
<script>
/* helpers */
function kataToHira(s){ return (s||"").replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60)); }
function hiraToKata(s){ return (s||"").replace(/[\u3041-\u3096]/g, ch => String.fromCharCode(ch.charCodeAt(0) + 0x60)); }
function normalizeForSearch(s){
  s = safeStr(s);
  s = s.replace(/　/g," ").toLowerCase();
  s = s.replace(/[()\[\]{}「」『』【】・,，.．/／\-ー―_]/g," ");
  s = s.replace(/\s+/g," ").trim();
  return kataToHira(s);
}
function setParam(key, value){
  try{
    const url = new URL(window.location.href);
    if(value === null || value === undefined || String(value).trim() === ""){
      url.searchParams.delete(key);
    }else{
      url.searchParams.set(key, String(value));
    }
    history.replaceState(null, "", url.toString());
  }catch(e){}
}

let showAgeCols = true;
function setAgeColsVisible(v){
  showAgeCols = v;
  document.querySelectorAll('.agecol').forEach(el=>{ el.style.display = v ? '' : 'none'; });
  document.getElementById('toggleCols').textContent = v ? '年齢別列：非表示' : '年齢別列：表示';
}
function signDelta(n){
  if(n==null) return `<span class="delta none">—</span>`;
  if(n>0) return `<span class="delta plus">+${n}</span>`;
  if(n<0) return `<span class="delta minus">${n}</span>`;
  return `<span class="delta zero">0</span>`;
}
function getGroups(f){
  if(f.age_groups) return f.age_groups;
  const ages = f.ages || f.ages_0_5 || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')}
  };
}
function stationKey(f){
  const sk = normalizeForSearch(f.station_kana || "");
  const st = normalizeForSearch((f.nearest_station || "").replace(/駅$/,''));
  return sk || st || "んんん";
}

function rowHTML(f, prevF){
  const station = safeStr(f.nearest_station||'');
  const walk = (f.walk_minutes==null || String(f.walk_minutes).trim()==="" ? '—' : `${Number(f.walk_minutes)}分`);

  const addr = safeStr(f.address||'');
  const map = safeStr(f.map_url||'');
  const mapLink = map ? `<a href="${map}" target="_blank" rel="noopener">Google Map</a>` : '—';

  const g = getGroups(f);
  function acc(k){ return fmt(g?.[k]?.accept); }
  function wai(k){ return fmt(g?.[k]?.wait); }

  const dWait = prevF ? (Number(f.totals?.wait||0) - Number(prevF.totals?.wait||0)) : null;
  const dAcc  = prevF ? (Number(f.totals?.accept||0) - Number(prevF.totals?.accept||0)) : null;

  return `<tr>
    <td data-col="name" class="col-name">
      <a href="facility.html?id=${encodeURIComponent(f.id)}">${safeStr(f.name)}</a>
      <div class="small">施設番号：${safeStr(f.id)}</div>
    </td>

    <td data-col="station">${station || '—'}</td>
    <td data-col="walk">${walk}</td>

    <td data-col="accept">${fmt(f.totals?.accept)}</td>
    <td data-col="wait">${fmt(f.totals?.wait)}</td>
    <td data-col="dwait">${signDelta(dWait)}</td>
    <td data-col="dacc">${signDelta(dAcc)}</td>

    <td data-col="a0a" class="agecol">${acc('0')}</td>
    <td data-col="a0w" class="agecol">${wai('0')}</td>
    <td data-col="a1a" class="agecol">${acc('1')}</td>
    <td data-col="a1w" class="agecol">${wai('1')}</td>
    <td data-col="a2a" class="agecol">${acc('2')}</td>
    <td data-col="a2w" class="agecol">${wai('2')}</td>
    <td data-col="a35a" class="agecol">${acc('3-5')}</td>
    <td data-col="a35w" class="agecol">${wai('3-5')}</td>

    <td data-col="addr" class="col-addr"><span class="cell-ellipsis">${addr || '—'}</span></td>
    <td data-col="map">${mapLink}</td>
  </tr>`;
}

function sortFacilities(arr, mode){
  const a=[...arr];
  function gwait(f, key){ const g = getGroups(f); return Number(g?.[key]?.wait ?? 0); }

  if(mode==='wait_desc'){
    a.sort((x,y)=>(Number(y.totals?.wait||0)-Number(x.totals?.wait||0)));
  } else if(mode==='accept_desc'){
    a.sort((x,y)=>(Number(y.totals?.accept||0)-Number(x.totals?.accept||0)));
  } else if(mode==='wait0_desc'){
    a.sort((x,y)=>gwait(y,"0")-gwait(x,"0"));
  } else if(mode==='wait1_desc'){
    a.sort((x,y)=>gwait(y,"1")-gwait(x,"1"));
  } else if(mode==='wait2_desc'){
    a.sort((x,y)=>gwait(y,"2")-gwait(x,"2"));
  } else if(mode==='wait35_desc'){
    a.sort((x,y)=>gwait(y,"3-5")-gwait(x,"3-5"));
  } else if(mode==='station_walk_asc'){
    a.sort((x,y)=>{
      const sx = stationKey(x);
      const sy = stationKey(y);
      if(sx !== sy) return sx.localeCompare(sy,'ja');

      const wx = (x.walk_minutes==null || String(x.walk_minutes).trim()==="" ? 9999 : Number(x.walk_minutes));
      const wy = (y.walk_minutes==null || String(y.walk_minutes).trim()==="" ? 9999 : Number(y.walk_minutes));
      if(wx !== wy) return wx - wy;

      return safeStr(x.name).localeCompare(safeStr(y.name),'ja');
    });
  } else if(mode==='name_asc'){
    a.sort((x,y)=>{
      const kx = normalizeForSearch(x.name_kana || x.name || "");
      const ky = normalizeForSearch(y.name_kana || y.name || "");
      const d = kx.localeCompare(ky,'ja');
      if(d!==0) return d;
      return safeStr(x.name).localeCompare(safeStr(y.name),'ja');
    });
  }
  return a;
}

function matchQuery(f, q){
  if(!q) return true;
  const q0 = normalizeForSearch(q);
  const qH = normalizeForSearch(kataToHira(q));
  const qK = normalizeForSearch(hiraToKata(q));

  const name = normalizeForSearch(f.name);
  const nk   = normalizeForSearch(f.name_kana);
  const st   = normalizeForSearch((f.nearest_station||"").replace(/駅$/,''));
  const sk   = normalizeForSearch(f.station_kana);

  return (
    name.includes(q0) ||
    nk.includes(q0) || nk.includes(qH) || nk.includes(qK) ||
    st.includes(q0) ||
    sk.includes(q0) || sk.includes(qH) || sk.includes(qK)
  );
}

function buildWardOptions(facilities){
  const set = new Set();
  for(const f of facilities){
    const w = safeStr(f.ward).trim();
    if(w) set.add(w);
  }
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'ja'));
}
function debounce(fn, ms=250){
  let t=null;
  return (...args)=>{
    if(t) clearTimeout(t);
    t=setTimeout(()=>fn(...args), ms);
  };
}

/* 表示モード：列の非表示（ヘッダー/本体 両方に適用） */
const COMPACT_HIDE_COLS = new Set([
  "addr","map",
  "dwait","dacc",
  "a0a","a0w","a1a","a1w","a2a","a2w","a35a","a35w"
]);
function isMobile(){ return window.matchMedia && window.matchMedia("(max-width: 768px)").matches; }
function applyViewMode(mode){
  const hide = (mode === "compact");

  // head
  document.querySelectorAll("#tblHead thead th").forEach(th=>{
    const c = th.getAttribute("data-col");
    if(!c) return;
    th.classList.toggle("hide-col", hide && COMPACT_HIDE_COLS.has(c));
  });
  // body
  document.querySelectorAll("#tblBody tbody td").forEach(td=>{
    const c = td.getAttribute("data-col");
    if(!c) return;
    td.classList.toggle("hide-col", hide && COMPACT_HIDE_COLS.has(c));
  });

  if(mode === "compact"){ setAgeColsVisible(false); }
}

/* colgroup でヘッダーと本体の列幅を揃える（重要） */
const COLS = [
  "name","station","walk","accept","wait","dwait","dacc",
  "a0a","a0w","a1a","a1w","a2a","a2w","a35a","a35w",
  "addr","map"
];
function buildCols(){
  const head = document.getElementById("colHead");
  const body = document.getElementById("colBody");
  head.innerHTML = COLS.map(c=>`<col data-col="${c}">`).join("");
  body.innerHTML = COLS.map(c=>`<col data-col="${c}">`).join("");
}

/* 横スクロール同期（本体→ヘッダー） */
function syncScroll(){
  const headWrap = document.getElementById("headWrap");
  const bodyWrap = document.getElementById("bodyWrap");
  headWrap.scrollLeft = bodyWrap.scrollLeft;
}

async function main(){
  buildCols();

  const months = await loadJSON('data/months.json');
  const ms = (months.months||[]).slice().sort();

  const monthSel = document.getElementById('monthSelect');
  monthSel.innerHTML = ms.map(m=>`<option value="${m}">${m}</option>`).join('');

  const pMonth = getParam('month');
  const pQ     = getParam('q');
  const pWard  = getParam('ward');
  const pSort  = getParam('sort');
  const pAge   = getParam('age');
  const pView  = getParam('view');

  monthSel.value = (pMonth && ms.includes(pMonth)) ? pMonth : (ms.length ? ms[ms.length-1] : '');

  const qEl = document.getElementById('q');
  if(pQ!=null) qEl.value = pQ;

  const sortEl = document.getElementById('sort');
  if(pSort && Array.from(sortEl.options).some(o=>o.value===pSort)) sortEl.value = pSort;

  setAgeColsVisible(pAge === "0" ? false : true);

  const wardSel = document.getElementById('wardSelect');
  const viewSel = document.getElementById('viewMode');

  if(pView && ["compact","full"].includes(pView)) viewSel.value = pView;
  else viewSel.value = "auto";

  // scroll sync
  document.getElementById("bodyWrap").addEventListener("scroll", syncScroll, { passive:true });

  async function render(){
    const month = monthSel.value;
    const idx = ms.indexOf(month);
    const prevMonth = (idx > 0) ? ms[idx - 1] : null;

    const data = await loadJSON(`data/${month}.json`);
    const prevData = prevMonth ? await loadJSON(`data/${prevMonth}.json`) : null;

    document.getElementById('monthLabel').textContent =
      prevMonth ? `${month}（前月：${prevMonth}）` : month;

    const prevMap = new Map();
    if(prevData && prevData.facilities){
      for(const pf of prevData.facilities){
        prevMap.set(String(pf.id), pf);
      }
    }

    const wards = buildWardOptions(data.facilities||[]);
    const curWard = (pWard ?? wardSel.value) || "";
    wardSel.innerHTML =
      `<option value="">全区</option>` +
      wards.map(w=>`<option value="${w}">${w}</option>`).join('');
    wardSel.value = wards.includes(curWard) ? curWard : "";

    const totWait = (data.facilities||[]).reduce((s,f)=>s+Number(f.totals?.wait||0),0);
    const totAcc  = (data.facilities||[]).reduce((s,f)=>s+Number(f.totals?.accept||0),0);

    const prevTotWait = prevData ? (prevData.facilities||[]).reduce((s,f)=>s+Number(f.totals?.wait||0),0) : null;
    const prevTotAcc  = prevData ? (prevData.facilities||[]).reduce((s,f)=>s+Number(f.totals?.accept||0),0) : null;

    const dTotWait = (prevTotWait==null) ? null : (totWait - prevTotWait);
    const dTotAcc  = (prevTotAcc==null) ? null : (totAcc - prevTotAcc);

    document.getElementById('kpi').innerHTML = `
      <div class="pill">合計 入所待ち：${fmt(totWait)}（前月比 ${signDelta(dTotWait)}）</div>
      <div class="pill">合計 受入可能：${fmt(totAcc)}（前月比 ${signDelta(dTotAcc)}）</div>
      <div class="pill">対象：${safeStr(data.ward||"横浜市")}</div>
    `;

    const q = qEl.value.trim();
    const sort = sortEl.value;
    const wardFilter = wardSel.value;

    let arr = data.facilities || [];
    const totalCount = arr.length;

    if(wardFilter){
      arr = arr.filter(f => safeStr(f.ward).trim() === wardFilter);
    }
    if(q){
      arr = arr.filter(f => matchQuery(f, q));
    }
    arr = sortFacilities(arr, sort);

    document.getElementById('countLabel').textContent =
      `${arr.length.toLocaleString('ja-JP')} / ${totalCount.toLocaleString('ja-JP')}`;

    // render body
    const tbody = document.querySelector('#tblBody tbody');
    tbody.innerHTML = arr.map(f => rowHTML(f, prevMap.get(String(f.id)))).join('');

    // apply view
    let view = viewSel.value;
    if(view === "auto"){ view = isMobile() ? "compact" : "full"; }
    applyViewMode(view);

    // URL params
    setParam('month', monthSel.value);
    setParam('q', qEl.value.trim());
    setParam('ward', wardSel.value);
    setParam('sort', sortEl.value);
    setParam('age', showAgeCols ? "" : "0");
    setParam('view', (viewSel.value === "auto") ? "" : viewSel.value);

    // scroll sync reset
    syncScroll();
  }

  const renderDebounced = debounce(render, 220);

  monthSel.addEventListener('change', render);
  sortEl.addEventListener('change', render);
  wardSel.addEventListener('change', render);
  qEl.addEventListener('input', renderDebounced);
  viewSel.addEventListener('change', render);

  document.getElementById('toggleCols').addEventListener('click', ()=>{
    setAgeColsVisible(!showAgeCols);
    render();
  });

  if(window.matchMedia){
    const mq = window.matchMedia("(max-width: 768px)");
    mq.addEventListener?.("change", ()=>{
      if(viewSel.value === "auto") render();
    });
  }

  await render();
}

main().catch(err=>{
  alert(err.message);
  console.error(err);
});
</script>
</body>
</html>
