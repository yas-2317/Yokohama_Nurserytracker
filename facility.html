<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園詳細</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- 崩れ対策 + 追加UI（facility側だけで完結） -->
  <style>
    .facility-hero .hero-grid{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 900px){
      .facility-hero .hero-grid{ grid-template-columns: 1fr; }
    }

    .hero-lines{ display:flex; flex-direction:column; gap:10px; }
    .hero-line{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .hero-line .label{
      min-width:72px;
      opacity:.8;
      white-space:nowrap;
    }
    .hero-line .value{
      flex:1;
      min-width:200px;
      word-break:break-word;
      overflow-wrap:anywhere;
    }

    /* 最寄りカード：駅・徒歩を詰めて1行表示 */
    .station-inline{
      display:flex;
      gap:6px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .station-inline .sep{ opacity:.6; }
    .station-inline .station{ font-weight:600; }
    .station-inline .walk{ opacity:.9; }

    /* 追加：カード群 */
    .mini-cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .mini-cards{ grid-template-columns: 1fr; }
    }
    .mini-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:10px 12px;
      background: var(--card-bg, #fff);
    }
    .mini-card .mc-title{
      font-size:12px;
      opacity:.75;
      margin-bottom:6px;
    }
    .mini-card .mc-main{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .mini-card .mc-value{
      font-size:20px;
      font-weight:700;
      line-height:1.2;
    }
    .mini-card .mc-sub{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
    }

    /* 年齢別カード */
    .age-cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .age-cards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .age-cards{ grid-template-columns: 1fr; }
    }
    .age-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:10px 12px;
      background: var(--card-bg, #fff);
    }
    .age-card .age-title{
      font-size:12px;
      opacity:.75;
      margin-bottom:8px;
    }
    .age-card .age-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:2px 0;
      font-size:14px;
    }
    .age-card .age-row b{ font-weight:700; }

    /* テーブルの見切れ防止 */
    .tablewrap{ overflow:auto; }
    table{ border-collapse:collapse; width:100%; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--card-bg, #fff);
    }
    thead th::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-1px;
      height:1px;
      background: rgba(0,0,0,.08);
    }

    /* URL折り返し */
    a{ overflow-wrap:anywhere; }
    .btn-secondary.btn-small{ white-space:nowrap; }
  </style>
</head>

<body>

<header class="page-header">
  <div class="container">
    <div class="header-top">
      <div class="titleblock">
        <h1 id="facName">園詳細</h1>
        <div class="sub">
          施設番号：<span id="facId">-</span>
          <span class="sep">/</span>
          最終更新：<span id="latestMonth">-</span>
        </div>
      </div>
      <div class="header-right">
        <a class="btn-link" href="index.html">← 一覧へ戻る</a>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- Summary -->
  <div class="card facility-hero">
    <div class="hero-grid">
      <div class="hero-main">

        <!-- 基本情報（行） -->
        <div class="hero-lines">
          <div class="hero-line">
            <span class="label">住所</span>
            <span id="facAddr" class="value">—</span>
            <button id="copyAddr" class="btn-secondary btn-small" type="button">コピー</button>
          </div>

          <div class="hero-line">
            <span class="label">地図</span>
            <span id="facMap" class="value">—</span>
          </div>

          <!-- ★要望：最寄り/徒歩を詰めて1行→改行して同駅リンク（1カード相当のまとまり） -->
          <div class="mini-card" style="margin-top:6px;">
            <div class="mc-title">最寄り</div>

            <div class="station-inline">
              <span id="facStation" class="station">—</span>
              <span class="sep">/</span>
              <span id="facWalk" class="walk">—</span>
            </div>

            <div style="margin-top:6px;">
              <a id="sameStationLink" class="btn-link" href="#" style="display:none;">同駅の園を見る</a>
            </div>
          </div>

          <div class="hero-line" style="margin-top:6px;">
            <span class="label">園HP</span>
            <span id="facWeb" class="value">—</span>
          </div>

          <div class="hero-line">
            <span class="label">電話</span>
            <span id="facPhone" class="value">—</span>
          </div>
        </div>

        <!-- 既存：大きいKPI（最新） -->
        <div class="hero-metrics">
          <div class="metric">
            <div class="metric-title">最新：入所待ち（合計）</div>
            <div class="metric-value" id="latestWait">-</div>
          </div>
          <div class="metric">
            <div class="metric-title">最新：受入可能（合計）</div>
            <div class="metric-value" id="latestAcc">-</div>
          </div>
        </div>

        <!-- ★要望：前月比をカード表示（待ち/受入） -->
        <div class="mini-cards" id="deltaCards"></div>

        <!-- ★要望：各年齢の受入/待ちをカード表示 -->
        <div class="age-cards" id="ageCards"></div>

      </div>

      <!-- Sparkline -->
      <div class="hero-side">
        <div class="small">推移（直近）</div>
        <div class="spark-block">
          <div class="spark-title">入所待ち（合計）</div>
          <div id="sparkWait"></div>
        </div>
        <div class="spark-block">
          <div class="spark-title">受入可能（合計）</div>
          <div id="sparkAcc"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Compact history -->
  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">月次推移（コンパクト）</div>
        <div class="small">月 / 合計（待ち・受入） / 前月比（待ち・受入）</div>
      </div>
      <div class="section-actions">
        <label class="inline">
          <span class="small">表示件数</span>
          <select id="limitSel">
            <option value="12">直近12</option>
            <option value="24" selected>直近24</option>
            <option value="60">直近60</option>
            <option value="999">全部</option>
          </select>
        </label>
      </div>
    </div>

    <div class="tablewrap tablewrap-tall">
      <table id="hist">
        <thead>
          <tr>
            <th style="min-width:120px;">月</th>
            <th class="num" style="min-width:130px;">入所待ち（合計）</th>
            <th style="min-width:130px;">前月比</th>
            <th class="num" style="min-width:130px;">受入可能（合計）</th>
            <th style="min-width:130px;">前月比</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <details class="details">
      <summary>年齢別の推移を見る（0 / 1 / 2 / 3-5）</summary>
      <div class="tablewrap tablewrap-tall">
        <table id="histAge">
          <thead>
            <tr>
              <th style="min-width:120px;">月</th>
              <th class="num" style="min-width:90px;">0 受入</th><th class="num" style="min-width:90px;">0 待ち</th>
              <th class="num" style="min-width:90px;">1 受入</th><th class="num" style="min-width:90px;">1 待ち</th>
              <th class="num" style="min-width:90px;">2 受入</th><th class="num" style="min-width:90px;">2 待ち</th>
              <th class="num" style="min-width:110px;">3-5 受入</th><th class="num" style="min-width:110px;">3-5 待ち</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </details>
  </div>

</main>

<script src="common.js"></script>
<script>
function toast(msg){
  try{
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position = 'fixed';
    el.style.left = '50%';
    el.style.bottom = '18px';
    el.style.transform = 'translateX(-50%)';
    el.style.background = 'rgba(0,0,0,.75)';
    el.style.color = '#fff';
    el.style.padding = '10px 12px';
    el.style.borderRadius = '10px';
    el.style.fontSize = '13px';
    el.style.zIndex = 9999;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 1400);
  }catch(e){}
}

function getGroups(f){
  if(f.age_groups) return f.age_groups;
  const ages = f.ages || f.ages_0_5 || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')}
  };
}

function signDelta(n){
  if(n==null) return `<span class="delta none">—</span>`;
  if(n>0) return `<span class="delta plus">+${n}</span>`;
  if(n<0) return `<span class="delta minus">${n}</span>`;
  return `<span class="delta zero">0</span>`;
}

function makeSparkline(values, labels, {width=300, height=150}={}){
  const xs = values.map(v => (v==null ? null : Number(v)));
  const clean = xs.filter(v => v!=null && isFinite(v));
  if(clean.length < 2) return `<div class="small">—</div>`;

  const dataMin = Math.min(...clean);
  const dataMax = Math.max(...clean);

  const padL = 36, padR = 8, padT = 8, padB = 42;
  const plotW = width - padL - padR;
  const plotH = height - padT - padB;

  function niceStep(range){
    if(range === 0) return 1;
    const rough = range / 4;
    const exp = Math.pow(10, Math.floor(Math.log10(rough)));
    const f = rough / exp;
    if(f < 1.5) return exp;
    if(f < 3.5) return 2 * exp;
    if(f < 7.5) return 5 * exp;
    return 10 * exp;
  }

  const step = niceStep(dataMax - dataMin || 1);
  const yMin = Math.floor(dataMin / step) * step;
  const yMax = Math.ceil(dataMax / step) * step;
  const yRange = (yMax - yMin) || 1;

  function yPx(v){ return padT + plotH - ((v - yMin) / yRange) * plotH; }
  function xPx(i){ return xs.length === 1 ? padL + plotW/2 : padL + (i/(xs.length-1))*plotW; }

  const yTicks = [];
  for(let v = yMin; v <= yMax * 1.001; v += step) yTicks.push(Math.round(v));

  const xLabelIdx = new Set([0, xs.length - 1]);
  const xStep = Math.max(1, Math.round((xs.length - 1) / 4));
  for(let i = xStep; i < xs.length - 1; i += xStep) xLabelIdx.add(i);

  const parts = [];

  // Y 軸グリッド + ラベル（人数）
  yTicks.forEach(v => {
    const py = yPx(v).toFixed(1);
    parts.push(`<line x1="${padL}" y1="${py}" x2="${padL+plotW}" y2="${py}" stroke="rgba(0,0,0,.08)" stroke-width="1"/>`);
    parts.push(`<text x="${padL-5}" y="${(+py+3.5).toFixed(1)}" text-anchor="end" font-size="10" fill="rgba(0,0,0,.45)">${v}</text>`);
  });

  // 軸線
  parts.push(`<line x1="${padL}" y1="${padT}" x2="${padL}" y2="${padT+plotH}" stroke="rgba(0,0,0,.2)" stroke-width="1"/>`);
  parts.push(`<line x1="${padL}" y1="${padT+plotH}" x2="${padL+plotW}" y2="${padT+plotH}" stroke="rgba(0,0,0,.2)" stroke-width="1"/>`);

  // X 軸ラベル（年月）
  if(labels){
    [...xLabelIdx].sort((a,b)=>a-b).forEach(i => {
      const px = xPx(i).toFixed(1);
      const baseY = padT + plotH;
      const lbl = (labels[i]||'').substring(0,7);
      parts.push(`<line x1="${px}" y1="${baseY}" x2="${px}" y2="${baseY+4}" stroke="rgba(0,0,0,.25)" stroke-width="1"/>`);
      parts.push(`<text x="${px}" y="${baseY+9}" text-anchor="end" font-size="10" fill="rgba(0,0,0,.5)" transform="rotate(-40,${px},${baseY+9})">${lbl}</text>`);
    });
  }

  // 折れ線
  let pathD = '';
  let started = false;
  xs.forEach((v,i)=>{
    if(v==null || !isFinite(v)) return;
    const px = xPx(i).toFixed(1), py = yPx(v).toFixed(1);
    if(!started){ pathD += `M ${px} ${py}`; started = true; }
    else { pathD += ` L ${px} ${py}`; }
  });
  parts.push(`<path d="${pathD}" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>`);

  return `<svg class="spark" viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" role="img" aria-label="sparkline">
    ${parts.join('\n    ')}
  </svg>`;
}

function makeDeltaCards(dWait, dAcc){
  return `
    <div class="mini-card">
      <div class="mc-title">前月比：入所待ち（合計）</div>
      <div class="mc-main">
        <div class="mc-value">${(dWait==null) ? "—" : (dWait>0 ? `+${dWait}` : `${dWait}`)}</div>
        <div class="mc-sub">${signDelta(dWait)}</div>
      </div>
    </div>
    <div class="mini-card">
      <div class="mc-title">前月比：受入可能（合計）</div>
      <div class="mc-main">
        <div class="mc-value">${(dAcc==null) ? "—" : (dAcc>0 ? `+${dAcc}` : `${dAcc}`)}</div>
        <div class="mc-sub">${signDelta(dAcc)}</div>
      </div>
    </div>
    <div class="mini-card">
      <div class="mc-title">前月比：合計（待ち＋受入）</div>
      <div class="mc-main">
        <div class="mc-value">${(dWait==null || dAcc==null) ? "—" : (dWait+dAcc>0 ? `+${dWait+dAcc}` : `${dWait+dAcc}`)}</div>
        <div class="mc-sub">${(dWait==null || dAcc==null) ? "—" : signDelta(dWait+dAcc)}</div>
      </div>
    </div>
  `;
}

function makeAgeCards(g){
  function row(label, accept, wait){
    return `
      <div class="age-card">
        <div class="age-title">${label}</div>
        <div class="age-row"><span>受入</span><b>${fmt(accept)}</b></div>
        <div class="age-row"><span>待ち</span><b>${fmt(wait)}</b></div>
      </div>
    `;
  }
  return `
    ${row('0歳', g?.['0']?.accept, g?.['0']?.wait)}
    ${row('1歳', g?.['1']?.accept, g?.['1']?.wait)}
    ${row('2歳', g?.['2']?.accept, g?.['2']?.wait)}
    ${row('3〜5歳', g?.['3-5']?.accept, g?.['3-5']?.wait)}
  `;
}

async function main(){
  const fid = getParam('id');
  if(!fid){
    alert('id が指定されていません');
    location.href = 'index.html';
    return;
  }

  const monthsObj = await loadJSON('data/months.json');
  const months = (monthsObj.months||[]).slice().sort(); // asc

  const hist = [];
  for(const m of months){
    try{
      const obj = await loadJSON(`data/${m}.json`);
      const fac = (obj.facilities||[]).find(x => String(x.id) === String(fid));
      if(fac) hist.push({month:m, fac});
    }catch(e){}
  }
  if(hist.length===0){
    alert('該当施設が見つかりません');
    location.href = 'index.html';
    return;
  }

  const latest = hist[hist.length-1];
  const prev = hist.length>=2 ? hist[hist.length-2] : null;

  const f = latest.fac;
  const pf = prev ? prev.fac : null;

  document.title = `${safeStr(f.name)}（園詳細）`;
  document.getElementById('facName').textContent = safeStr(f.name);
  document.getElementById('facId').textContent = safeStr(f.id);
  document.getElementById('latestMonth').textContent = latest.month;

  const addr = safeStr(f.address || '');
  document.getElementById('facAddr').textContent = addr || '—';

  const map = safeStr(f.map_url || '');
  document.getElementById('facMap').innerHTML =
    map ? `<a href="${map}" target="_blank" rel="noopener">Google Map を開く</a>` : '—';

  const st = safeStr(f.nearest_station || '');
  const wk = toIntOrNull(f.walk_minutes);
  document.getElementById('facStation').textContent = st || '—';
  document.getElementById('facWalk').textContent = (wk==null ? '—' : `徒歩${wk}分`);

  // 同駅リンク（改行して表示）
  const stationQuery = (safeStr(f.station_kana).trim() || safeStr(f.nearest_station).replace(/駅$/,'').trim());
  if(stationQuery){
    const url = `index.html?q=${encodeURIComponent(stationQuery)}&sort=station_walk_asc`;
    const a = document.getElementById('sameStationLink');
    a.href = url;
    a.style.display = '';
  }

  // website / phone
  const web = safeStr(f.website || "");
  document.getElementById('facWeb').innerHTML =
    web ? `<a href="${web}" target="_blank" rel="noopener">公式サイトを開く</a>` : '—';

  const phoneRaw = safeStr(f.phone || "");
  const phoneJP = formatJPPhone(phoneRaw);
  document.getElementById('facPhone').innerHTML =
    phoneJP ? `<a href="${telHref(phoneJP)}">${phoneJP}</a>` : '—';


  // copy
  const copyBtn = document.getElementById('copyAddr');
  if(copyBtn){
    copyBtn.addEventListener('click', async ()=>{
      try{
        if(!addr) return;
        await navigator.clipboard.writeText(addr);
        toast('住所をコピーしました');
      }catch(e){
        alert('コピーに失敗しました');
      }
    });
  }

  // latest totals
  const wait = Number(f.totals?.wait ?? 0);
  const acc  = Number(f.totals?.accept ?? 0);
  document.getElementById('latestWait').textContent = fmtNum(wait);
  document.getElementById('latestAcc').textContent  = fmtNum(acc);

  // deltas
  const dWait = pf ? (Number(f.totals?.wait||0) - Number(pf.totals?.wait||0)) : null;
  const dAcc  = pf ? (Number(f.totals?.accept||0) - Number(pf.totals?.accept||0)) : null;
  document.getElementById('deltaCards').innerHTML = makeDeltaCards(dWait, dAcc);

  // age cards
  const g = getGroups(f);
  document.getElementById('ageCards').innerHTML = makeAgeCards(g);

  // sparkline
  const lastN = hist.slice(Math.max(0, hist.length-24));
  const waitSeries   = lastN.map(x => Number(x.fac.totals?.wait ?? 0));
  const accSeries    = lastN.map(x => Number(x.fac.totals?.accept ?? 0));
  const monthLabels  = lastN.map(x => x.month);
  document.getElementById('sparkWait').innerHTML = makeSparkline(waitSeries, monthLabels);
  document.getElementById('sparkAcc').innerHTML  = makeSparkline(accSeries, monthLabels);

  // history tables
  const limitSel = document.getElementById('limitSel');
  function renderTables(){
    const lim = Number(limitSel.value || 24);
    const slice = (lim>=999) ? hist : hist.slice(Math.max(0, hist.length - lim));

    const rows = [];
    for(let i=0;i<slice.length;i++){
      const cur = slice[i];
      const prevv = (i>0) ? slice[i-1] : null;
      const cw = Number(cur.fac.totals?.wait ?? 0);
      const ca = Number(cur.fac.totals?.accept ?? 0);
      const dw = prevv ? (cw - Number(prevv.fac.totals?.wait ?? 0)) : null;
      const da = prevv ? (ca - Number(prevv.fac.totals?.accept ?? 0)) : null;

      rows.push(`<tr>
        <td>${cur.month}</td>
        <td class="num">${fmtNum(cw)}</td>
        <td>${signDelta(dw)}</td>
        <td class="num">${fmtNum(ca)}</td>
        <td>${signDelta(da)}</td>
      </tr>`);
    }
    document.querySelector('#hist tbody').innerHTML = rows.reverse().join('');

    const rows2 = slice.map(cur=>{
      const gg = getGroups(cur.fac);
      function n(v){ return fmt(v); }
      return `<tr>
        <td>${cur.month}</td>
        <td class="num">${n(gg?.['0']?.accept)}</td><td class="num">${n(gg?.['0']?.wait)}</td>
        <td class="num">${n(gg?.['1']?.accept)}</td><td class="num">${n(gg?.['1']?.wait)}</td>
        <td class="num">${n(gg?.['2']?.accept)}</td><td class="num">${n(gg?.['2']?.wait)}</td>
        <td class="num">${n(gg?.['3-5']?.accept)}</td><td class="num">${n(gg?.['3-5']?.wait)}</td>
      </tr>`;
    });
    document.querySelector('#histAge tbody').innerHTML = rows2.reverse().join('');
  }

  limitSel.addEventListener('change', renderTables);
  renderTables();
}

main().catch(err=>{
  alert(err.message);
  console.error(err);
});
</script>
</body>
</html>
