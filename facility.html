<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園の詳細</title>
  <link rel="stylesheet" href="styles.css?v=20260215a"/>
</head>
<body>
<header>
  <div class="container">
    <div class="topbar">
      <a class="backlink" href="./">← 一覧に戻る</a>
    </div>
    <h1 id="title">園の詳細</h1>
    <div class="sub" id="subtitle">-</div>
  </div>
</header>

<main class="container">
  <div class="card" id="basic"></div>

  <div class="card tablewrap">
    <h2 class="h2">月次履歴</h2>
    <table id="hist">
      <thead>
        <tr>
          <th style="min-width:130px;">月</th>
          <th>受入可能（合計）</th>
          <th>入所待ち（合計）</th>
          <th class="agecol">0歳 受入</th><th class="agecol">0歳 待ち</th>
          <th class="agecol">1歳 受入</th><th class="agecol">1歳 待ち</th>
          <th class="agecol">2歳 受入</th><th class="agecol">2歳 待ち</th>
          <th class="agecol">3〜5歳 受入</th><th class="agecol">3〜5歳 待ち</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script src="common.js"></script>
<script>
function getGroups(f){
  if(f.age_groups) return f.age_groups;
  const ages = f.ages || f.ages_0_5 || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')}
  };
}

function histRow(month, f){
  const g = getGroups(f);
  function acc(k){ return fmt(g?.[k]?.accept); }
  function wai(k){ return fmt(g?.[k]?.wait); }
  return `<tr>
    <td>${safeStr(month)}</td>
    <td>${fmt(f.totals?.accept)}</td>
    <td>${fmt(f.totals?.wait)}</td>
    <td class="agecol">${acc('0')}</td><td class="agecol">${wai('0')}</td>
    <td class="agecol">${acc('1')}</td><td class="agecol">${wai('1')}</td>
    <td class="agecol">${acc('2')}</td><td class="agecol">${wai('2')}</td>
    <td class="agecol">${acc('3-5')}</td><td class="agecol">${wai('3-5')}</td>
  </tr>`;
}

async function main(){
  const id = getParam('id');
  if(!id) throw new Error('idが指定されていません');

  const months = await loadJSON('data/months.json');
  const ms = (months.months||[]).slice().sort().reverse(); // newest first

  let latest = null;
  let latestMonth = null;

  const rows = [];
  for(const m of ms){
    const d = await loadJSON(`data/${m}.json`);
    const f = (d.facilities||[]).find(x => String(x.id) === String(id));
    if(!f) continue;
    if(!latest){
      latest = f;
      latestMonth = m;
    }
    rows.push(histRow(m, f));
  }

  if(!latest) throw new Error('対象施設が見つかりませんでした');

  document.getElementById('title').textContent = latest.name;
  document.title = latest.name + ' | 園の詳細';
  document.getElementById('subtitle').textContent = `施設番号：${safeStr(latest.id)} / 区：${safeStr(latest.ward)} / 最新：${safeStr(latestMonth)}`;

  const addr = safeStr(latest.address||'');
  const map = safeStr(latest.map_url||'');
  const link = map ? `<a href="${map}" target="_blank" rel="noopener">Google Map</a>` : '';

  const g = getGroups(latest);
  const a0 = fmt(g?.["0"]?.accept), w0 = fmt(g?.["0"]?.wait);
  const a1 = fmt(g?.["1"]?.accept), w1 = fmt(g?.["1"]?.wait);
  const a2 = fmt(g?.["2"]?.accept), w2 = fmt(g?.["2"]?.wait);
  const a35 = fmt(g?.["3-5"]?.accept), w35 = fmt(g?.["3-5"]?.wait);

  document.getElementById('basic').innerHTML = `
    <div class="kpi">
      <div class="pill">最新 受入可能（合計）：${fmt(latest.totals?.accept)}</div>
      <div class="pill">最新 入所待ち（合計）：${fmt(latest.totals?.wait)}</div>
      <div class="pill">0歳：受入 ${a0} / 待ち ${w0}</div>
      <div class="pill">1歳：受入 ${a1} / 待ち ${w1}</div>
      <div class="pill">2歳：受入 ${a2} / 待ち ${w2}</div>
      <div class="pill">3〜5歳：受入 ${a35} / 待ち ${w35}</div>
    </div>
    <div class="detailgrid">
      <div><b>住所</b><br>${addr || '（未設定）'}</div>
      <div><b>地図</b><br>${link || '（未設定）'}</div>
    </div>
  `;

  document.querySelector('#hist tbody').innerHTML = rows.join('');
}

function boot(){
  main().catch(err=>{
    alert(err.message);
    console.error(err);
  });
}
document.addEventListener('DOMContentLoaded', boot);
window.addEventListener('pageshow', (e)=>{ if(e.persisted) boot(); });
</script>
</body>
</html>
