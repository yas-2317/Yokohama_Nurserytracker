<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園詳細 | 横浜市 保育園データ</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="container">
    <h1 id="title">園詳細</h1>
    <div class="sub">
      データ時点：<span id="monthLabel">-</span>
      <span id="wardLabel"></span>
    </div>

    <div class="controls">
      <a class="badge" href="index.html">← 一覧に戻る</a>
      <select id="monthSelect"></select>
      <button id="toggleCols">年齢別列：非表示</button>
      <span class="badge">※「入所待ち人数」は園ごとの申込件数（重複計上あり）</span>
    </div>
  </div>
</header>

<main class="container">
  <!-- Summary card -->
  <div class="card">
    <div class="kpi" id="kpi"></div>

    <div style="margin-top:10px;">
      <div class="small" id="metaLine"></div>
    </div>
  </div>

  <!-- Monthly history table -->
  <div class="card tablewrap">
    <table id="hist">
      <thead>
        <tr>
          <th style="min-width:120px;">月</th>

          <th style="min-width:110px;">受入可能（合計）</th>
          <th style="min-width:110px;">入所待ち（合計）</th>
          <th style="min-width:120px;">前月比 入所待ち</th>
          <th style="min-width:120px;">前月比 受入可能</th>

          <th class="agecol" style="min-width:90px;">0歳 受入</th><th class="agecol" style="min-width:90px;">0歳 待ち</th>
          <th class="agecol" style="min-width:90px;">1歳 受入</th><th class="agecol" style="min-width:90px;">1歳 待ち</th>
          <th class="agecol" style="min-width:90px;">2歳 受入</th><th class="agecol" style="min-width:90px;">2歳 待ち</th>
          <th class="agecol" style="min-width:110px;">3〜5歳 受入</th><th class="agecol" style="min-width:110px;">3〜5歳 待ち</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">
    出典：横浜市「保育所等の入所状況（毎月1日時点）」の公開データを加工（本サイトは非公式）。
  </div>
</main>

<script src="common.js"></script>
<script>
let showAgeCols = true;

function setAgeColsVisible(v){
  showAgeCols = v;
  document.querySelectorAll('.agecol').forEach(el=>{
    el.style.display = v ? '' : 'none';
  });
  const btn = document.getElementById('toggleCols');
  if(btn) btn.textContent = v ? '年齢別列：非表示' : '年齢別列：表示';
}

function signDelta(n){
  if(n==null) return `<span class="delta none">—</span>`;
  if(n>0) return `<span class="delta plus">+${n}</span>`;
  if(n<0) return `<span class="delta minus">${n}</span>`;
  return `<span class="delta zero">0</span>`;
}

function getGroups(f){
  if(f && f.age_groups) return f.age_groups;

  const ages = (f && (f.ages || f.ages_0_5)) || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')}
  };
}

function rowHTML(month, curF, prevF){
  const g = getGroups(curF);

  function acc(k){ return fmt(g?.[k]?.accept); }
  function wai(k){ return fmt(g?.[k]?.wait); }

  const dWait = prevF ? (Number(curF.totals?.wait||0) - Number(prevF.totals?.wait||0)) : null;
  const dAcc  = prevF ? (Number(curF.totals?.accept||0) - Number(prevF.totals?.accept||0)) : null;

  return `<tr>
    <td>${safeStr(month)}</td>

    <td>${fmt(curF.totals?.accept)}</td>
    <td>${fmt(curF.totals?.wait)}</td>
    <td>${signDelta(dWait)}</td>
    <td>${signDelta(dAcc)}</td>

    <td class="agecol">${acc('0')}</td><td class="agecol">${wai('0')}</td>
    <td class="agecol">${acc('1')}</td><td class="agecol">${wai('1')}</td>
    <td class="agecol">${acc('2')}</td><td class="agecol">${wai('2')}</td>
    <td class="agecol">${acc('3-5')}</td><td class="agecol">${wai('3-5')}</td>
  </tr>`;
}

function buildKPI(f, prevF){
  const name = safeStr(f.name);
  const ward = safeStr(f.ward);
  const station = safeStr(f.nearest_station);
  const walk = (f.walk_minutes==null || f.walk_minutes==="" ? "—" : `${Number(f.walk_minutes)}分`);
  const addr = safeStr(f.address);
  const map = safeStr(f.map_url);
  const mapLink = map ? `<a href="${map}" target="_blank" rel="noopener">Google Map</a>` : '—';

  const wait = Number(f.totals?.wait||0);
  const acc  = Number(f.totals?.accept||0);

  const dWait = prevF ? (wait - Number(prevF.totals?.wait||0)) : null;
  const dAcc  = prevF ? (acc - Number(prevF.totals?.accept||0)) : null;

  document.getElementById('title').textContent = name || '園詳細';
  document.title = `${name || '園詳細'} | 横浜市 保育園データ`;

  document.getElementById('wardLabel').textContent = ward ? ` / 区：${ward}` : "";

  document.getElementById('kpi').innerHTML = `
    <div class="pill">入所待ち（合計）：${fmt(wait)}（前月比 ${signDelta(dWait)}）</div>
    <div class="pill">受入可能（合計）：${fmt(acc)}（前月比 ${signDelta(dAcc)}）</div>
    <div class="pill">最寄り：${station || '—'} / 徒歩：${walk}</div>
  `;

  const meta = [
    `施設番号：${safeStr(f.id)}`,
    `住所：${addr || '—'}`,
    `地図：${mapLink}`,
    (f.website ? `Web：<a href="${safeStr(f.website)}" target="_blank" rel="noopener">${safeStr(f.website)}</a>` : ""),
    (f.phone ? `TEL：${safeStr(f.phone)}` : ""),
  ].filter(Boolean).join(" / ");

  document.getElementById('metaLine').innerHTML = meta;
}

async function main(){
  const id = (getParam('id') || "").trim();
  if(!id){
    throw new Error("URLに id がありません（例：facility.html?id=1410...）");
  }

  const monthsObj = await loadJSON('data/months.json');
  const months = (monthsObj.months||[]).slice().sort();

  const sel = document.getElementById('monthSelect');
  sel.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join('');
  sel.value = months.length ? months[months.length-1] : '';

  setAgeColsVisible(true);

  async function findFacilityInMonth(month){
    const obj = await loadJSON(`data/${month}.json`);
    const facs = obj.facilities || [];
    const f = facs.find(x => String(x.id) === String(id));
    return { monthObj: obj, facility: f || null };
  }

  async function render(){
    const month = sel.value;
    const idx = months.indexOf(month);
    const prevMonth = (idx > 0) ? months[idx - 1] : null;

    // current month facility
    const cur = await findFacilityInMonth(month);
    const f = cur.facility;
    if(!f){
      throw new Error(`この月（${month}）に施設が見つかりません：id=${id}`);
    }

    // prev month facility for delta
    let prevF = null;
    if(prevMonth){
      const prev = await findFacilityInMonth(prevMonth);
      prevF = prev.facility;
    }

    document.getElementById('monthLabel').textContent =
      prevMonth ? `${month}（前月：${prevMonth}）` : month;

    buildKPI(f, prevF);

    // history: scan all months, keep those where this id exists
    const rows = [];
    for(let i=0;i<months.length;i++){
      const m = months[i];
      const obj = await loadJSON(`data/${m}.json`);
      const facs = obj.facilities || [];
      const curF = facs.find(x => String(x.id) === String(id));
      if(!curF) continue;

      // prev (previous existing month for this facility)
      let pF = null;
      for(let j=i-1; j>=0; j--){
        const m2 = months[j];
        const obj2 = await loadJSON(`data/${m2}.json`);
        const f2 = (obj2.facilities||[]).find(x => String(x.id) === String(id));
        if(f2){ pF = f2; break; }
      }
      rows.push({ month: m, curF, prevF: pF });
    }

    // latest first
    rows.sort((a,b)=>String(b.month).localeCompare(String(a.month)));

    const tbody = document.querySelector('#hist tbody');
    tbody.innerHTML = rows.map(r => rowHTML(r.month, r.curF, r.prevF)).join('');
    setAgeColsVisible(showAgeCols);
  }

  sel.addEventListener('change', render);
  document.getElementById('toggleCols').addEventListener('click', ()=>{
    setAgeColsVisible(!showAgeCols);
  });

  await render();
}

main().catch(err=>{
  alert(err.message);
  console.error(err);
});
</script>
</body>
</html>
