<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園詳細</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>

<header class="page-header">
  <div class="container">
    <div class="header-top">
      <div class="titleblock">
        <h1 id="facName">園詳細</h1>
        <div class="sub">
          施設番号：<span id="facId">-</span>
          <span class="sep">/</span>
          最終更新：<span id="latestMonth">-</span>
        </div>
      </div>
      <div class="header-right">
        <a class="btn-link" id="backLink" href="index.html">← 一覧へ戻る</a>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- Summary (カード化) -->
  <div class="card facility-hero">
    <div class="hero-grid">
      <div class="hero-main">
        <div class="hero-lines">
          <div class="hero-line">
            <span class="label">住所</span>
            <span id="facAddr" class="value">—</span>
            <button id="copyAddr" class="btn-secondary btn-small" type="button">コピー</button>
          </div>

          <div class="hero-line">
            <span class="label">地図</span>
            <span id="facMap" class="value">—</span>
          </div>

          <div class="hero-line">
            <span class="label">最寄り</span>
            <span id="facStation" class="value">—</span>
            <span class="sep">/</span>
            <span id="facWalk" class="value">—</span>
            <a id="sameStationLink" class="btn-link" href="#" style="display:none;">同駅の園を見る</a>
          </div>

          <!-- ★追加：園の公式サイト -->
          <div class="hero-line">
            <span class="label">公式</span>
            <span id="facWeb" class="value">—</span>
          </div>
        </div>

        <div class="hero-metrics">
          <div class="metric">
            <div class="metric-title">最新：入所待ち（合計）</div>
            <div class="metric-value" id="latestWait">-</div>
            <div class="metric-sub">前月比 <span id="latestWaitDelta">—</span></div>
          </div>
          <div class="metric">
            <div class="metric-title">最新：受入可能（合計）</div>
            <div class="metric-value" id="latestAcc">-</div>
            <div class="metric-sub">前月比 <span id="latestAccDelta">—</span></div>
          </div>
        </div>

        <div class="chips" id="ageChips"></div>
      </div>

      <!-- Sparkline -->
      <div class="hero-side">
        <div class="small">推移（直近）</div>
        <div class="spark-block">
          <div class="spark-title">入所待ち（合計）</div>
          <div id="sparkWait"></div>
        </div>
        <div class="spark-block">
          <div class="spark-title">受入可能（合計）</div>
          <div id="sparkAcc"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact history -->
  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">月次推移（コンパクト）</div>
        <div class="small">月 / 合計（待ち・受入） / 前月比（待ち・受入）</div>
      </div>
      <div class="section-actions">
        <label class="inline">
          <span class="small">表示件数</span>
          <select id="limitSel">
            <option value="12">直近12</option>
            <option value="24" selected>直近24</option>
            <option value="60">直近60</option>
            <option value="999">全部</option>
          </select>
        </label>
      </div>
    </div>

    <div class="tablewrap tablewrap-tall">
      <table id="hist">
        <thead>
          <tr>
            <th style="min-width:120px;">月</th>
            <th class="num" style="min-width:130px;">入所待ち（合計）</th>
            <th style="min-width:130px;">前月比</th>
            <th class="num" style="min-width:130px;">受入可能（合計）</th>
            <th style="min-width:130px;">前月比</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <details class="details">
      <summary>年齢別の推移を見る（0 / 1 / 2 / 3-5）</summary>
      <div class="tablewrap tablewrap-tall">
        <table id="histAge">
          <thead>
            <tr>
              <th style="min-width:120px;">月</th>
              <th class="num" style="min-width:90px;">0 受入</th><th class="num" style="min-width:90px;">0 待ち</th>
              <th class="num" style="min-width:90px;">1 受入</th><th class="num" style="min-width:90px;">1 待ち</th>
              <th class="num" style="min-width:90px;">2 受入</th><th class="num" style="min-width:90px;">2 待ち</th>
              <th class="num" style="min-width:110px;">3-5 受入</th><th class="num" style="min-width:110px;">3-5 待ち</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </details>
  </div>

</main>

<script src="common.js"></script>
<script>
function getGroups(f){
  if(f.age_groups) return f.age_groups;
  const ages = f.ages || f.ages_0_5 || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')}
  };
}

function signDelta(n){
  if(n==null) return `<span class="delta none">—</span>`;
  if(n>0) return `<span class="delta plus">+${n}</span>`;
  if(n<0) return `<span class="delta minus">${n}</span>`;
  return `<span class="delta zero">0</span>`;
}

function makeSparkline(values, {width=260, height=60}={}){
  const xs = values.map(v => (v==null ? null : Number(v)));
  const clean = xs.filter(v => v!=null && isFinite(v));
  if(clean.length < 2){
    return `<div class="small">—</div>`;
  }
  const min = Math.min(...clean);
  const max = Math.max(...clean);
  const pad = 6;
  const w = width, h = height;

  function y(v){
    if(max===min) return h/2;
    const t = (v - min) / (max - min);
    return (h - pad) - t*(h - pad*2);
  }
  function x(i){
    if(xs.length===1) return pad;
    return pad + i*(w - pad*2)/(xs.length-1);
  }

  let d = '';
  let started = false;
  xs.forEach((v,i)=>{
    if(v==null || !isFinite(v)) return;
    const px = x(i), py = y(v);
    if(!started){
      d += `M ${px} ${py}`;
      started = true;
    } else {
      d += ` L ${px} ${py}`;
    }
  });

  return `
  <svg class="spark" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}" role="img" aria-label="sparkline">
    <path d="${d}" fill="none" stroke="currentColor" stroke-width="2" />
  </svg>`;
}

// index の状態を保持して URL を作る（存在するものだけ引き継ぐ）
function carryIndexState(baseUrl){
  const u = new URL(window.location.href);
  const keys = ["month","q","ward","sort","age"];
  const params = new URLSearchParams();
  for(const k of keys){
    const v = u.searchParams.get(k);
    if(v!=null && String(v).trim()!==""){
      params.set(k, v);
    }
  }
  const qs = params.toString();
  return qs ? `${baseUrl}?${qs}` : baseUrl;
}

function buildIndexURLWithOverrides(overrides={}){
  const u = new URL(window.location.href);
  const keys = ["month","q","ward","sort","age"];
  const params = new URLSearchParams();
  for(const k of keys){
    const v = u.searchParams.get(k);
    if(v!=null && String(v).trim()!==""){
      params.set(k, v);
    }
  }
  for(const [k,v] of Object.entries(overrides)){
    if(v==null || String(v).trim()===""){
      params.delete(k);
    }else{
      params.set(k, String(v));
    }
  }
  const qs = params.toString();
  return qs ? `index.html?${qs}` : "index.html";
}

function normalizeWebsiteUrl(url){
  const s = safeStr(url).trim();
  if(!s) return "";
  if(/^https?:\/\//i.test(s)) return s;
  // たまに "www.xxx" 等だけ入ることがあるので補正
  return "https://" + s;
}

async function main(){
  const fid = getParam('id');
  if(!fid){
    alert('id が指定されていません');
    location.href = buildIndexURLWithOverrides({});
    return;
  }

  // ★一覧へ戻るリンク（index の状態を保持）
  document.getElementById('backLink').href = buildIndexURLWithOverrides({});

  const monthsObj = await loadJSON('data/months.json');
  const months = (monthsObj.months||[]).slice().sort(); // asc

  // load all months, pick facility
  const hist = [];
  for(const m of months){
    try{
      const obj = await loadJSON(`data/${m}.json`);
      const fac = (obj.facilities||[]).find(x => String(x.id) === String(fid));
      if(fac){
        hist.push({month:m, fac});
      }
    }catch(e){
      // ignore missing
    }
  }
  if(hist.length===0){
    alert('該当施設が見つかりません');
    location.href = buildIndexURLWithOverrides({});
    return;
  }

  // latest & prev
  const latest = hist[hist.length-1];
  const prev = hist.length>=2 ? hist[hist.length-2] : null;

  const f = latest.fac;
  const pf = prev ? prev.fac : null;

  // title
  document.title = `${safeStr(f.name)}（園詳細）`;
  document.getElementById('facName').textContent = safeStr(f.name);
  document.getElementById('facId').textContent = safeStr(f.id);
  document.getElementById('latestMonth').textContent = latest.month;

  // address/map/station/walk
  const addr = safeStr(f.address || '');
  document.getElementById('facAddr').textContent = addr || '—';

  const map = safeStr(f.map_url || '');
  document.getElementById('facMap').innerHTML = map ? `<a href="${map}" target="_blank" rel="noopener">Google Map を開く</a>` : '—';

  const st = safeStr(f.nearest_station || '');
  const wk = toIntOrNull(f.walk_minutes);
  document.getElementById('facStation').textContent = st || '—';
  document.getElementById('facWalk').textContent = (wk==null ? '—' : `徒歩 ${wk}分`);

  // ★追加：公式サイト
  const web = normalizeWebsiteUrl(f.website || "");
  document.getElementById('facWeb').innerHTML = web
    ? `<a href="${web}" target="_blank" rel="noopener">園の公式サイトを開く</a>`
    : '—';

  // same station link（index状態保持 + 駅検索に上書き）
  const stationQuery = (safeStr(f.station_kana).trim() || safeStr(f.nearest_station).replace(/駅$/,'').trim());
  if(stationQuery){
    const url = buildIndexURLWithOverrides({
      q: stationQuery,
      sort: "station_walk_asc",
    });
    const a = document.getElementById('sameStationLink');
    a.href = url;
    a.style.display = '';
  }

  // copy address（toast無しでも落ちない）
  const copyBtn = document.getElementById('copyAddr');
  copyBtn.addEventListener('click', async ()=>{
    if(!addr){
      alert('住所がありません');
      return;
    }
    try{
      await navigator.clipboard.writeText(addr);
      const old = copyBtn.textContent;
      copyBtn.textContent = 'コピーしました';
      setTimeout(()=>{ copyBtn.textContent = old; }, 1200);
    }catch(e){
      // clipboard不可環境のフォールバック
      try{
        const ta = document.createElement('textarea');
        ta.value = addr;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const old = copyBtn.textContent;
        copyBtn.textContent = 'コピーしました';
        setTimeout(()=>{ copyBtn.textContent = old; }, 1200);
      }catch(e2){
        alert('コピーに失敗しました');
      }
    }
  });

  // latest totals & deltas
  const wait = Number(f.totals?.wait ?? 0);
  const acc  = Number(f.totals?.accept ?? 0);
  const dWait = pf ? (Number(f.totals?.wait||0) - Number(pf.totals?.wait||0)) : null;
  const dAcc  = pf ? (Number(f.totals?.accept||0) - Number(pf.totals?.accept||0)) : null;

  document.getElementById('latestWait').textContent = fmtNum(wait);
  document.getElementById('latestAcc').textContent  = fmtNum(acc);
  document.getElementById('latestWaitDelta').innerHTML = signDelta(dWait);
  document.getElementById('latestAccDelta').innerHTML  = signDelta(dAcc);

  // age chips (latest)
  const g = getGroups(f);
  function chip(label, a, w){
    const aa = fmt(a);
    const ww = fmt(w);
    return `<div class="chip"><div class="chip-title">${label}</div><div class="chip-body">受入 ${aa} / 待ち ${ww}</div></div>`;
  }
  document.getElementById('ageChips').innerHTML = `
    ${chip('0歳', g?.['0']?.accept, g?.['0']?.wait)}
    ${chip('1歳', g?.['1']?.accept, g?.['1']?.wait)}
    ${chip('2歳', g?.['2']?.accept, g?.['2']?.wait)}
    ${chip('3〜5歳', g?.['3-5']?.accept, g?.['3-5']?.wait)}
  `;

  // sparkline from last N
  const lastN = hist.slice(Math.max(0, hist.length-24));
  const waitSeries = lastN.map(x => Number(x.fac.totals?.wait ?? 0));
  const accSeries  = lastN.map(x => Number(x.fac.totals?.accept ?? 0));
  document.getElementById('sparkWait').innerHTML = makeSparkline(waitSeries);
  document.getElementById('sparkAcc').innerHTML  = makeSparkline(accSeries);

  // history tables
  const limitSel = document.getElementById('limitSel');

  function renderTables(){
    const lim = Number(limitSel.value || 24);
    const slice = (lim>=999) ? hist : hist.slice(Math.max(0, hist.length - lim));

    // compact table (with deltas)
    const rows = [];
    for(let i=0;i<slice.length;i++){
      const cur = slice[i];
      const prevv = (i>0) ? slice[i-1] : null;
      const cw = Number(cur.fac.totals?.wait ?? 0);
      const ca = Number(cur.fac.totals?.accept ?? 0);
      const dw = prevv ? (cw - Number(prevv.fac.totals?.wait ?? 0)) : null;
      const da = prevv ? (ca - Number(prevv.fac.totals?.accept ?? 0)) : null;

      rows.push(`<tr>
        <td>${cur.month}</td>
        <td class="num">${fmtNum(cw)}</td>
        <td>${signDelta(dw)}</td>
        <td class="num">${fmtNum(ca)}</td>
        <td>${signDelta(da)}</td>
      </tr>`);
    }
    document.querySelector('#hist tbody').innerHTML = rows.reverse().join(''); // latest on top

    // age history (latest on top)
    const rows2 = slice.map(cur=>{
      const gg = getGroups(cur.fac);
      function n(v){ return fmt(v); }
      return `<tr>
        <td>${cur.month}</td>
        <td class="num">${n(gg?.['0']?.accept)}</td><td class="num">${n(gg?.['0']?.wait)}</td>
        <td class="num">${n(gg?.['1']?.accept)}</td><td class="num">${n(gg?.['1']?.wait)}</td>
        <td class="num">${n(gg?.['2']?.accept)}</td><td class="num">${n(gg?.['2']?.wait)}</td>
        <td class="num">${n(gg?.['3-5']?.accept)}</td><td class="num">${n(gg?.['3-5']?.wait)}</td>
      </tr>`;
    });
    document.querySelector('#histAge tbody').innerHTML = rows2.reverse().join('');
  }

  limitSel.addEventListener('change', renderTables);
  renderTables();
}

main().catch(err=>{
  alert(err.message);
  console.error(err);
});
</script>
</body>
</html>
