name: Monthly update (Yokohama nursery)

on:
  workflow_dispatch:
    inputs:
      ward_filter:
        description: "対象区（例：港北区）。空欄なら全件"
        required: false
        default: "港北区"
  schedule:
    - cron: '30 0 * * *'  # UTC 00:30 = JST 09:30

permissions:
  contents: write

concurrency:
  group: monthly-update
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with remote (rebase)
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run update_from_yokohama.py
        shell: bash
        env:
          WARD_FILTER: ${{ github.event.inputs.ward_filter || '港北区' }}
        run: |
          set -euxo pipefail
          python -u scripts/update_from_yokohama.py
          ls -la data || true

      - name: Verify generated JSON has kana/station fields
        shell: bash
        run: |
          set -euxo pipefail
          python - << 'PY'
          import json
          m = json.load(open("data/months.json", encoding="utf-8"))["months"][-1]
          p = f"data/{m}.json"
          d = json.load(open(p, encoding="utf-8"))
          f = d["facilities"][0]
          print("month =", m)
          for k in ["name","name_kana","nearest_station","station_kana","walk_minutes","address","map_url"]:
            print(k, "=", f.get(k))
          missing = [k for k in ["name_kana","station_kana","nearest_station","walk_minutes"] if k not in f]
          if missing:
            raise SystemExit("Missing keys in JSON: " + ",".join(missing))
          print("OK: keys exist")
          PY

      - name: Commit & push
        shell: bash
        run: |
          set -euxo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes."
            exit 0
          fi

          git add data || true
          git commit -m "Update nursery data" || true

          git fetch origin main
          git rebase origin/main
          git push origin main
